generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid()) @map("_id") @db.Uuid
  name      String
  email     String   @unique
  password  String
  role      UserRole @default(buyer)
  createdAt DateTime @default(now())
  phone     String?
  updatedAt DateTime
  Vendor    Vendor?

  @@index([email])
  @@index([role])
  @@map("users")
}

model Vendor {
  status       VendorStatus @default(pending)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  address      String?
  businessName String
  gstNumber    String?
  kycDocsUrl   String[]     @default([])
  id           String       @id @default(uuid()) @map("_id") @db.Uuid
  userId       String       @unique @db.Uuid
  users        User         @relation(fields: [userId], references: [id])
}

enum VendorStatus {
  pending
  approved
  rejected
}

enum UserRole {
  buyer
  seller
  admin
  super_admin
}

/// Status of a seller’s product listing
enum ProductListingStatus {
  ACTIVE // Product is available for purchase
  INACTIVE // Temporarily hidden (e.g. out of business)
  OUT_OF_STOCK // Inventory exhausted
  DISCONTINUED // Permanently removed by seller
}

//
// MODELS
//

/// Represents a unique product (shared across all vendors)
model Product {
  id          String   @id @default(uuid()) // Global product ID
  title       String // Product name
  description String? // Optional full description (Markdown/HTML)
  category    String? // E.g., "Electronics > Phones"
  imageUrls   String[] // Array of image URLs (MinIO + ImageKit)
  createdAt   DateTime @default(now()) // Creation timestamp
  updatedAt   DateTime @updatedAt // Auto-update on change

  listings ProductListing[] // Linked listings from various sellers

  @@index([title])
  @@index([category])
}

/// Represents a seller-specific listing of a product
model ProductListing {
  id          String               @id @default(uuid()) // Unique listing ID (product + seller variant)
  productId   String // FK to base product
  sellerId    String // FK to vendor-service
  sku         String?              @unique // Optional: Seller-defined SKU code
  price       Decimal // Price set by seller
  stock       Int                  @default(0) // Current stock count
  deliveryEta String? // Optional ETA (e.g., "3-5 days")
  status      ProductListingStatus @default(ACTIVE) // Status of this listing
  updatedAt   DateTime             @updatedAt // Auto-updated when record changes
  createdAt   DateTime             @default(now()) // Created when seller listed

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([sellerId])
  @@index([productId])
  @@index([status])
}

enum RatingTargetType {
  PRODUCT // Buyer rating a product
  SELLER // Buyer rating a seller
}

//
// MODELS
//

/// Stores individual reviews left by buyers for products or sellers
model Rating {
  id         String           @id @default(uuid()) // Unique rating ID
  userId     String // FK to User (buyer)
  targetId   String // FK to Product or Seller depending on type
  targetType RatingTargetType // Indicates what entity is being rated
  stars      Int // Star rating (1–5)
  comment    String? // Optional review comment
  createdAt  DateTime         @default(now()) // Timestamp when rating was submitted

  @@unique([userId, targetId, targetType]) // Prevent duplicate ratings per user per target
  @@index([userId])
  @@index([targetId])
  @@index([targetType])
}
