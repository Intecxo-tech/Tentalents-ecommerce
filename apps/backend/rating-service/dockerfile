# ===========================
# Stage 1: Builder
# ===========================
FROM node:20-alpine AS builder
WORKDIR /app

# 1️⃣ Copy root package files and install all dependencies
COPY package.json package-lock.json ./
RUN npm ci

# 2️⃣ Copy only the service and shared libs
COPY apps/backend/rating-service ./apps/backend/rating-service
COPY libs ./libs

# 3️⃣ Build the rating-service (including dependent libs)
RUN npx nx build rating-service --configuration=production --skip-nx-cache

# ===========================
# Stage 2: Production Runtime
# ===========================
FROM node:20-alpine AS runtime
WORKDIR /app
ENV NODE_ENV=production

# 4️⃣ Install only production dependencies
COPY package.json package-lock.json ./
RUN npm ci --omit=dev

# 5️⃣ Copy the built rating-service
COPY --from=builder /app/dist/apps/backend/rating-service ./

# 6️⃣ Copy built libs
COPY --from=builder /app/dist/libs ./libs

# 7️⃣ Expose the service port
EXPOSE 3007

# 8️⃣ Start the service
CMD ["node", "main.js"]



# docker build -t rating-service:latest -f apps/backend/rating-service/Dockerfile .

# docker run -d --name rating-service \
#   -p 3007:3007 \
#   --env NODE_ENV=production \
#   rating-service:latest

# docker logs -f rating-service

# docker stop rating-service
# docker rm rating-service

